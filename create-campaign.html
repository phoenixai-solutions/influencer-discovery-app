<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create New Campaign - Phoenix</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafc;
      color: #1a1a1a;
    }
    .top-bar {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      background: #ef4444;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .logo-text {
      font-size: 18px;
      font-weight: 600;
    }
    .user-badge {
      width: 40px;
      height: 40px;
      background: #0066ff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    .nav-tabs {
      background: white;
      padding: 0 24px;
      display: flex;
      gap: 32px;
      border-bottom: 1px solid #e5e7eb;
    }
    .nav-tab {
      padding: 12px 0;
      color: #6b7280;
      text-decoration: none;
      font-weight: 500;
      border-bottom: 2px solid transparent;
    }
    .nav-tab.active {
      color: #0066ff;
      border-bottom-color: #0066ff;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    .back-link {
      color: #6b7280;
      text-decoration: none;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 24px;
    }
    .back-link:hover {
      color: #111827;
    }
    .page-header {
      margin-bottom: 32px;
    }
    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .page-header p {
      color: #6b7280;
      font-size: 15px;
    }
    .form-container {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 32px;
    }
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 32px;
      border-bottom: 1px solid #e5e7eb;
    }
    .form-section:last-of-type {
      border-bottom: none;
      padding-bottom: 0;
    }
    .section-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #111827;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }
    .required {
      color: #dc2626;
      margin-left: 4px;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #0066ff;
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-help {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .input-prefix {
      position: relative;
    }
    .input-prefix .prefix {
      position: absolute;
      left: 12px;
      top: 11px;
      color: #6b7280;
      font-weight: 500;
    }
    .input-prefix input {
      padding-left: 28px;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    .btn {
      padding: 10px 24px;
      border-radius: 8px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-secondary {
      background: white;
      border: 1px solid #d1d5db;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #f9fafb;
    }
    .btn-primary {
      background: #0066ff;
      color: white;
    }
    .btn-primary:hover {
      background: #0052cc;
    }
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    /* Loading and Error States */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert-error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
    }
    .alert-success {
      background: #f0fdf4;
      border: 1px solid #bbf7d0;
      color: #16a34a;
    }
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Navigation will be injected here -->
  <div id="app-navigation"></div>

  <!-- Main Content -->
  <div class="container">
    
    <a href="campaigns.html" class="back-link">‚Üê Back to Campaigns</a>

    <div class="page-header">
      <h1>Create New Campaign</h1>
      <p>Fill in the details below to create your influencer marketing campaign</p>
    </div>

    <!-- Alert Messages -->
    <div id="alertContainer"></div>

    <form id="campaignForm" class="form-container">
      
      <!-- Campaign Details Section -->
      <div class="form-section">
        <h2 class="section-title">Campaign Details</h2>
        
        <div class="form-group">
          <label class="form-label">
            Campaign Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="campaignName"
            name="campaignName"
            class="form-input" 
            placeholder="e.g., Spring Product Launch 2025"
            required 
          />
        </div>
          <div class="form-group">
    <label class="form-label">
      Brand Partner (Optional)
    </label>
    <input 
      type="text" 
      id="partner"
      name="partner"
      class="form-input" 
      placeholder="e.g., Nike, Local Restaurant Group, Tourism Board"
    />
    <div class="form-help">If this campaign is in partnership with another brand or organization</div>
  </div>

        <div class="form-group">
          <label class="form-label">
            Campaign Status <span class="required">*</span>
          </label>
          <select id="status" name="status" class="form-select" required>
            <option value="Planning" selected>Planning</option>
            <option value="Active">Active</option>
            <option value="Paused">Paused</option>
            <option value="Completed">Completed</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">
            Campaign Objective <span class="required">*</span>
          </label>
          <textarea 
            id="objective"
            name="objective"
            class="form-textarea" 
            placeholder="What are the goals of this campaign?"
            required
          ></textarea>
          <div class="form-help">Describe what you want to achieve with this campaign</div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              Campaign Budget <span class="required">*</span>
            </label>
            <div class="input-prefix">
              <span class="prefix">$</span>
              <input 
                type="number" 
                id="budget"
                name="budget"
                class="form-input" 
                placeholder="50000"
                min="0"
                step="100"
                required 
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              Start Date <span class="required">*</span>
            </label>
            <input 
              type="date" 
              id="startDate"
              name="startDate"
              class="form-input" 
              required 
            />
          </div>

          <div class="form-group">
            <label class="form-label">
              End Date <span class="required">*</span>
            </label>
            <input 
              type="date" 
              id="endDate"
              name="endDate"
              class="form-input" 
              required 
            />
          </div>
        </div>
      </div>

      <!-- Target Audience Section -->
      <div class="form-section">
        <h2 class="section-title">Target Audience</h2>
        
        <div class="form-group">
          <label class="form-label">
            Target Audience Description
          </label>
          <textarea 
            id="targetAudience"
            name="targetAudience"
            class="form-textarea" 
            placeholder="Describe your target audience demographics, interests, and behaviors..."
          ></textarea>
          <div class="form-help">This helps influencers create more relevant content</div>
        </div>
      </div>

      <!-- Deliverables Section -->
      <div class="form-section">
        <h2 class="section-title">Deliverable Requirements</h2>
        
        <div class="form-group">
          <label class="form-label">
            Deliverables Description
          </label>
          <textarea 
            id="deliverables"
            name="deliverables"
            class="form-textarea" 
            style="min-height: 100px;"
            placeholder="e.g., 10 Instagram Reels, 5 LinkedIn posts, 3 YouTube videos..."
          ></textarea>
          <div class="form-help">List the types and quantities of content you need</div>
        </div>
      </div>

      <!-- Campaign Tracking Section -->
      <div class="form-section">
        <h2 class="section-title">Campaign Tracking</h2>
        
        <div class="form-group">
          <label class="form-label">
            Campaign Hashtags
          </label>
          <input 
            type="text" 
            id="hashtags"
            name="hashtags"
            class="form-input" 
            placeholder="e.g., #summersale, #brandname, #campaign2025"
          />
          <div class="form-help">Comma-separated hashtags for tracking campaign posts</div>
        </div>

        <div class="form-group">
          <label class="form-label">
            Required Phrases
          </label>
          <input 
            type="text" 
            id="requiredPhrases"
            name="requiredPhrases"
            class="form-input" 
            placeholder="e.g., Brand name, Product features, Call to action"
          />
          <div class="form-help">Key phrases or terms that must appear in influencer content</div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
        <button type="submit" id="submitBtn" class="btn btn-primary">
          <span id="submitText">Create Campaign</span>
        </button>
      </div>

    </form>

  </div>

  <script>
    // ================================================
    // API Configuration
    // ================================================
    const API_CONFIG = {
      createCampaign: 'https://phoenixaisolutions.app.n8n.cloud/webhook/create-campaign'
    };

    // ================================================
    // DOM Elements
    // ================================================
    const form = document.getElementById('campaignForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const cancelBtn = document.getElementById('cancelBtn');
    const alertContainer = document.getElementById('alertContainer');

    // ================================================
    // Helper Functions
    // ================================================

    function showAlert(message, type = 'error') {
      alertContainer.innerHTML = `
        <div class="alert alert-${type}">
          ${message}
        </div>
      `;
      // Scroll to top to show alert
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Auto-dismiss success messages after 3 seconds
      if (type === 'success') {
        setTimeout(() => {
          alertContainer.innerHTML = '';
        }, 3000);
      }
    }

    function clearAlert() {
      alertContainer.innerHTML = '';
    }

    function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      if (isLoading) {
        submitText.innerHTML = '<span class="loading-spinner"></span>Creating...';
      } else {
        submitText.textContent = 'Create Campaign';
      }
    }

    // ================================================
    // Form Submission Handler
    // ================================================

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAlert();
      
      // Get form data
      const formData = new FormData(form);
      
      // Build payload object with correct field names
      const payload = {
        campaignName: formData.get('campaignName').trim(),
        status: formData.get('status'),
        budget: parseFloat(formData.get('budget')),
        startDate: formData.get('startDate'),
        endDate: formData.get('endDate'),
        objective: formData.get('objective').trim(),
        deliverables: formData.get('deliverables').trim(),
        targetAudience: formData.get('targetAudience').trim(),
        hashtags: formData.get('hashtags').trim(),
        requiredPhrases: formData.get('requiredPhrases').trim()
      };

      // Client-side validation
      if (!payload.campaignName) {
        showAlert('Campaign name is required');
        return;
      }

      if (!payload.budget || payload.budget < 0) {
        showAlert('Please enter a valid budget');
        return;
      }

      if (!payload.startDate || !payload.endDate) {
        showAlert('Start and end dates are required');
        return;
      }

      // Check that end date is after start date
      const startDate = new Date(payload.startDate);
      const endDate = new Date(payload.endDate);
      
      if (endDate < startDate) {
        showAlert('End date must be after start date');
        return;
      }

      if (!payload.objective) {
        showAlert('Campaign objective is required');
        return;
      }

      // Log payload for debugging
      console.log('üì§ Sending payload:', payload);

      // Set loading state
      setLoading(true);

try {
  // Send to n8n webhook
  const response = await fetch(API_CONFIG.createCampaign, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  });

  console.log('üì• Response status:', response.status);
  console.log('üì• Response headers:', [...response.headers.entries()]);
  
  // Get the raw response text first
  const responseText = await response.text();
  console.log('üì• Raw response text:', responseText);
  console.log('üì• Response text length:', responseText.length);
  
  // Check if response is empty
  if (!responseText || responseText.trim().length === 0) {
    console.error('‚ùå Response body is empty!');
    showAlert('Server returned empty response. Campaign may have been created - check Airtable.');
    setLoading(false);
    return;
  }
  
  // Try to parse JSON
  let result;
  try {
    result = JSON.parse(responseText);
    console.log('‚úÖ Parsed JSON successfully:', result);
  } catch (parseError) {
    console.error('‚ùå JSON parse error:', parseError);
    console.error('‚ùå Failed to parse this text:', responseText);
    showAlert('Server returned invalid JSON: ' + responseText.substring(0, 100));
    setLoading(false);
    return;
  }

  // Check if successful
  if (response.ok && result.success) {
    showAlert('Campaign created successfully! Redirecting...', 'success');
    
    // Clear draft
    localStorage.removeItem('campaignDraft');
    
    // Redirect to campaigns page after short delay
    setTimeout(() => {
      window.location.href = 'campaigns.html';
    }, 1500);
    
  } else {
    // Handle error response
    const errorMessage = result.error || result.message || 'Failed to create campaign';
    showAlert(errorMessage);
    setLoading(false);
  }

} catch (error) {
  console.error('‚ùå Error creating campaign:', error);
  showAlert('Network error: Could not connect to server. Please try again.');
  setLoading(false);
}
    });

    // ================================================
    // Cancel Button Handler
    // ================================================

    cancelBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        window.location.href = 'campaigns.html';
      }
    });

    // ================================================
    // Date Validation
    // ================================================

    // Set minimum date to today for start date
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    const today = new Date().toISOString().split('T')[0];
    startDateInput.setAttribute('min', today);

    // Update end date minimum when start date changes
    startDateInput.addEventListener('change', () => {
      endDateInput.setAttribute('min', startDateInput.value);
      
      // If end date is now before start date, clear it
      if (endDateInput.value && endDateInput.value < startDateInput.value) {
        endDateInput.value = '';
      }
    });

    // ================================================
    // Form Auto-save (Optional)
    // ================================================

    // Save form data to localStorage on input
    let saveTimeout;
    const formInputs = form.querySelectorAll('input, select, textarea');
    
    formInputs.forEach(input => {
      input.addEventListener('input', () => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          localStorage.setItem('campaignDraft', JSON.stringify(data));
          console.log('üíæ Draft saved');
        }, 1000);
      });
    });

    // Restore draft on page load
    window.addEventListener('DOMContentLoaded', () => {
      const draft = localStorage.getItem('campaignDraft');
      if (draft) {
        try {
          const data = JSON.parse(draft);
          Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && data[key]) {
              input.value = data[key];
            }
          });
          console.log('üìù Draft restored');
        } catch (e) {
          console.error('Error restoring draft:', e);
        }
      }
    });

    // Clear draft after successful submission
    window.addEventListener('beforeunload', (e) => {
      if (!form.checkValidity()) {
        // Keep draft if form is incomplete
        return;
      }
    });

  </script>
    <!-- ADD THIS: Load Navigation Script -->
  <script src="nav-component.js"></script>
  <script>
PhoenixNav.init({
  currentPage: 'campaigns',
  currentSubPage: 'create'
});
  </script>
</body>
</html>