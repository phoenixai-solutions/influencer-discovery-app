<script>
  const token =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiNWQzZTU0ZWItOTc5Ny00OThhLTk4YTEtMDY0MDUyMGQzMzk2IiwidGVuYW50X2lkIjoiZGQzOTEwMGEtNjBkNC00NzQzLWExNTktMzNmMTJlZTdkMjU3IiwidGVuYW50X2FwcF9pZCI6IjU4OThmNTRjLTRiNmUtNDJmMi1iMTc1LTA0YTQ5Yjc2NGViNCIsInByb2R1Y3RzIjpbIkVOR0FHRU1FTlQiLCJFTkdBR0VNRU5UX0FVRElFTkNFIiwiSURFTlRJVFkiXSwiaXNzIjoiaHR0cHM6Ly9hcGkuZ2V0cGh5bGxvLmNvbSIsImF1ZCI6Imh0dHBzOi8vYXBpLmdldHBoeWxsby5jb20vdjEvaW50ZXJuYWwiLCJpYXQiOjE3NjM4MzgwMzAuMzQ2MjgyLCJleHAiOjE3NjQ0NDI4MzAuMzQ2Mjc3fQ.CuBvG5e6RKlxjxVT1-snPzAgjILqxcm9R1S51Y7eB0s";
  const userId = "5d3e54eb-9797-498a-98a1-0640520d3396";

  const debugEl = document.getElementById("debug");
  function log(msg, obj, isError) {
    const time = new Date().toISOString();
    const icon = isError ? "❌" : "ℹ️";
    debugEl.textContent += `[${time}] ${icon} ${msg}\n`;
    if (obj) debugEl.textContent += JSON.stringify(obj, null, 2) + "\n";
  }

  log("Page JS loaded.");
  setTimeout(() => {
    log("typeof window.PhylloConnect:", typeof window.PhylloConnect);
  }, 500);

  document.getElementById("connectBtn").onclick = () => {
    log("Connect button clicked.");

    if (!window.PhylloConnect) {
      log("PhylloConnect SDK not found on window.", null, true);
      alert("PhylloConnect SDK failed to load.");
      return;
    }

    const config = {
      token,
      userId, // ✅ new line – this fixes "Please provide user id in config"
      environment: "sandbox", // Phyllo test env; token itself is for staging
      clientDisplayName: "Phoenix / Damien Staging Test",
    };

    log("Initialising PhylloConnect with config:", config);

    try {
      const phylloConnect = window.PhylloConnect.initialize(config);

      phylloConnect.on(
        "accountConnected",
        (accountId, workPlatformId, connectedUserId) => {
          log("accountConnected:", { accountId, workPlatformId, connectedUserId });
        }
      );

      phylloConnect.on("exit", (reason, connectedUserId) => {
        log("exit:", { reason, connectedUserId });
      });

      log("Opening Phyllo Connect UI...");
      phylloConnect.open();
    } catch (e) {
      log("Error during PhylloConnect.initialize/open:", { error: e.message }, true);
      alert("Error initialising Phyllo Connect: " + e.message);
    }
  };
</script>
