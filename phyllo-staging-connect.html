<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Phyllo Connect – Staging</title>

  <script src="https://cdn.getphyllo.com/connect/v2/phyllo-connect.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f5f7fb;
      padding: 40px;
      text-align: center;
    }
    button {
      font-size: 16px;
      padding: 12px 24px;
      border-radius: 999px;
      background: #111827;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #000;
    }
    pre {
      margin-top: 2rem;
      text-align: left;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      white-space: pre-wrap;
      overflow-x: auto;
    }
  </style>
</head>

<body>
  <h2>Phyllo Connect – Staging</h2>
  <p>Click below to connect your real social account via Phyllo Staging.</p>

  <button id="connectBtn">Connect Account</button>

  <pre id="debug"></pre>

  <script>
    /* =============================
       1) YOUR SDK TOKEN GOES HERE
       ============================= */
    const token = "YOUR_SDK_TOKEN_HERE";

    /* =============================
       2) YOUR STAGING USER ID
       ============================= */
    const userId = "5d3e54eb-9797-498a-98a1-0640520d3396";

    const debugEl = document.getElementById("debug");
    function log(msg, obj, isError) {
      const time = new Date().toISOString();
      const icon = isError ? "❌" : "ℹ️";
      debugEl.textContent += `[${time}] ${icon} ${msg}\n`;
      if (obj) debugEl.textContent += JSON.stringify(obj, null, 2) + "\n";
    }

    window.addEventListener("load", () => {
      log("Page JS loaded.");

      setTimeout(() => {
        log("typeof window.PhylloConnect:", typeof window.PhylloConnect);
      }, 300);

      document.getElementById("connectBtn").onclick = () => {
        log("Connect button clicked.");

        if (!window.PhylloConnect) {
          log("PhylloConnect SDK not found.", null, true);
          alert("SDK failed to load.");
          return;
        }

        const config = {
          token,
          userId,
          environment: "sandbox",
          clientDisplayName: "Phoenix / Damien Staging Test"
        };

        log("Initialising PhylloConnect with config:", config);

        try {
          const phylloConnect = window.PhylloConnect.initialize(config);

          // REQUIRED CALLBACKS
          phylloConnect.on("accountConnected",
            (accountId, workPlatformId, connectedUserId) => {
              log("accountConnected:", { accountId, workPlatformId, connectedUserId });
            }
          );

          phylloConnect.on("accountDisconnected",
            (accountId, workPlatformId, connectedUserId) => {
              log("accountDisconnected:", { accountId, workPlatformId, connectedUserId });
            }
          );

          phylloConnect.on("exit",
            (reason, connectedUserId) => {
              log("exit:", { reason, connectedUserId });
            }
          );

          /* =============================
             ✔ CORRECTED TOKEN EXPIRED EVENT
             ============================= */
          phylloConnect.on("tokenExpired",
            (expiredUserId) => {
              log("tokenExpired event fired:", { expiredUserId });
              alert("Your Phyllo token expired — generate a new one.");
            }
          );

          log("Opening Phyllo Connect UI…");
          phylloConnect.open();

        } catch (e) {
          log("Error during PhylloConnect.initialize/open:", { error: e.message }, true);
          alert("Error initialising Phyllo: " + e.message);
        }
      };
    });
  </script>

</body>
</html>